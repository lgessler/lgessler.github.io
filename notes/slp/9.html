<!doctype html>
<html lang="en">
<head>
<title>Speech and Language Processing 3ed draft, Chapter 9, Markov Chains</title>
<!-- 2018-08-25 Sat 01:53 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Luke Gessler">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script><link rel='stylesheet' type='text/css' href='/css/styles.css'>
            <link href="https://fonts.googleapis.com/css?family=Roboto"
                  rel="stylesheet">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "center",
  displayIndent: "2em",
  messageStyle: "none",
  "HTML-CSS": {
    scale: 100,
    styles: {
      ".MathJax_Display": {
        "font-size": "100%"
      }
    }
  },
  "SVG": {
    scale: 100,
    styles: {
      ".MathJax_SVG_Display": {
        "font-size": "100%",
        "margin-left": "-2.281em"
      }
    }
  }
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_SVG"></script>
</head>
<body>
<div id="preamble" class="">
<div class="container"><div class="row"><div class="col-md-9"><div style="font-size:11px;text-align:center;"><a style="color:gray;" href="/">Home</a> <a style="color:gray;" href="/posts/">Blog</a></div><div style="margin-top:0px;margin-bottom:-12px;color:#a0a0a0;">Luke Gessler</div></div></div></div>
</div>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Speech and Language Processing 3ed draft, Chapter 9, Markov Chains</h1>
<style>
body { 
    max-width: 800px; 
    margin: 0 auto 0 auto;
} 
img { width: 100%; }
</style>
<!-- for svg -->
<style> .figure object { height: 250px; } </style>

<div id="outline-container-sec-" class="outline-2">
<h2 id="sec-">Notes</h2>
<div class="outline-text-2" id="text-">
</div><div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">9.1 Markov Chains</h3>
<div class="outline-text-3" id="text-">
<p>
Formal components: states, transition probability matrix, start and end state:
</p>

<ul class="org-ul">
<li>\( Q = q_1q_2\ldots q_N \)
</li>
<li>\( A = a_{01}a_{02}\ldots a_{n1}\ldots a_{nn} \)
</li>
<li>\( q_0, q_F \)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">9.2 Hidden Markov Models</h3>
<div class="outline-text-3" id="text-">
<p>
Parts:
</p>

<ul class="org-ul">
<li>\( Q = q_1q_2\ldots q_N \)
<ul class="org-ul">
<li>A set of \(N\) states
</li>
</ul>
</li>
<li>\( A = a_{11}a_{12}\ldots a_{n1}\ldots a_{nn} \)
<ul class="org-ul">
<li>A transition probability matrix
</li>
</ul>
</li>
<li>\( O = o_1o_2\ldots o_T \)
<ul class="org-ul">
<li>A sequence of observations, each one drawn from \( V = v_1,v_2, \ldots, v_V \)
</li>
</ul>
</li>
<li>\(B = b_i(o_t)\)
<ul class="org-ul">
<li>A sequence of observation likelihoods/emission probabilities, i.e., \(p(o_t)\) at state \(i\)
</li>
</ul>
</li>
<li>\(q_0,q_F\)
</li>
</ul>

<p>
Three fundamental problems:
</p>

<ul class="org-ul">
<li>Likelihood: given an HMM \(\lambda = (A,B)\) and an observation sequence \(O\), determine \(P(O|\lambda)\)
</li>
<li>Decoding: given an observation sqeuence \(O\) and an HMM \(\lambda = (A,B)\), discover the best hidden state sequence \(Q\)
</li>
<li>Learning: Given an observation sequence \(O\) and the set of states in the HMM, learn the HMM parameters \(A\) and \(B\)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">9.3 Computing likelihood, forward algorithm</h3>
<div class="outline-text-3" id="text-">
<p>
Naive algorithm for \(P(O|\lambda)\): 
</p>

<p>
\[ \sum_Q P(O|Q)P(Q) \text{ where } P(O|Q)P(Q) = \prod_{i=1}^TP(o_i|q_i) \prod_{i=1}^TP(q_i|q_{i-1}) \] 
</p>

<p>
This takes exponential time to compute, not practical
</p>

<p>
Forward algorithm takes \(O(N^2T)\) time:
</p>

<ul class="org-ul">
<li>Construct forward trellis
</li>
<li>Each cell in trellis represents probability of being in a certain state after \(j\) observations: \(\alpha_t(j) = P(o_1, \ldots, o_t,q_t=j|\lambda)\)
</li>
<li>To compute \(\alpha_t(j)\), sum over every possible path: 
</li>
</ul>

<p>
\[ \alpha_t(j) = \sum_{i=1}^N a_{t-1}(i) a_{ij} b_j(o_t) \]
</p>

<ul class="org-ul">
<li>\(\alpha_{t-1}(i)\) is a previous cell's value, \(a_{ij}\) is the transition probability, and \(b_j(o_t)\) is the probability of observing \(o_t\) at state \(j\)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">9.4 Decoding, Viterbi algorithm</h3>
<div class="outline-text-3" id="text-">
<p>
Want to find most likely \(Q=q_1q_2q_3\ldots q_T\) given \(\lambda\) and \(O=o_1,o_2,\ldots,o_T\). 
</p>

<p>
Viterbi is also a DP algorithm that uses a trellis. Each cell expresses the probability:
</p>

<p>
\[ v_t(j) = \max_{q_0,q_1,\ldots,q_{t-1}}P(q_0,q_1,\ldots q_{t-1},o_1,o_2,\ldots o_t, q_t=j|\lambda) \]
</p>

<p>
Each cell is computed as:
</p>

<p>
\[ v_t(j) = \max_{i=1}^N v_{t-1}(i)a_{ij}b_j(o_t) \]
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">9.5 Training, forward-backward algorithm</h3>
<div class="outline-text-3" id="text-">
<p>
Given a sequence of observations \(O\) and a set of possible states \(Q\), need to find the HMM parameters \(A\) (transition probabilities) and \(B\) (emission probabilities).
</p>

<p>
If we were training a Markov chain, we could estimate each transition probability by expectation maximization:
</p>

<p>
\[ a_{ij} = \frac{C(i\rightarrow j)}{\sum_{q \in Q} C(i\rightarrow q)} \]
</p>

<p>
But in HMM training, we don't know which states we were in. Baum-Welch algorithm applies two intuitions:
</p>

<ol class="org-ol">
<li>Iteratively estimate counts
</li>
<li>Compute forward probability for an observation, but then also divide that probability mass among all paths that contributed to it
</li>
</ol>

<p>
Background: backward probability \(\beta\), the probability of seeing the observations from the time \(t + 1\) to the end, given that we are in state \(i\) at time \(t\), computed inductively as with the forward algorithm:
</p>

<p>
\[ \beta_t(i) = P(o_{t+1},o_{t+2},\ldots,o_T|q_t = i,\lambda) \]
</p>

<p>
Let \(\xi_t\) be the probability of being in state \(i\) at time \(t\) and state \(j\) at time \(t+1\):
</p>

<p>
\[ \xi_t(i,j) = P(q_t=i,q_{t+1}=j|O,\lambda) \]
</p>

<p>
To compute \(\xi_t\), compute something similar that includes probability of the observation:
</p>

<p>
\[ \text{not-quite-}\xi_t(i,j) = P(q_t=i,q_{t+1}=j,O|\lambda)  \]
</p>

<p>
This can be computed using forward and backward probabilities:
</p>

<p>
\[ \text{not-quite-}\xi_t(i,j) = \alpha_t(i)a_{ij}b_j(o_{t+1})\beta_{t+1}(j) \]
</p>

<p>
Now, to arrive at \(\xi\), divide by \(P(O|\lambda)\), since
</p>

<p>
\[ P(X|Y,Z) = \frac{P(X,Y|Z)}{P(Y|Z)} \]
</p>

<p>
Can be computed a number of different ways:
</p>

<p>
\[ P(O|\lambda) = \alpha_T(q_F) = \beta_T(q_0) = \sum_{j=1}^N \alpha_t(j)\beta_t(j) \]
</p>

<p>
Putting it all together, \(\xi_t\):
</p>

<p>
\[ \xi_t(i,j) = \frac{\alpha_t(i)a_{ij}b_j(o_{t+1})\beta_{t+1}(j)}{\alpha_T(q_F)} \]
</p>

<p>
We need to estimate \(a_{ij}\):
</p>

<p>
\[ \hat{a}_{ij} = \frac{\sum_{t=1}^{T-1}\xi_t(i,j)}{\sum_{t=1}^{T-1}\sum_{k=1}^N\xi_t(i,k)} \]
</p>

<p>
Also need to estimate \(b_j(v_k)\):
</p>

<p>
\[ \hat{b}_j(v_k) = \frac{\text{expected number of times in state }j\text{ and observing symbol }v_k}{\text{expected number of times in state }j} \]
</p>

<p>
For this, need probability of being in state \(j\) at time \(t\), \(\gamma_t(j)\):
</p>

<p>
\[ \gamma_t(j) = P(q_t=j|O,\lambda) \]
</p>

<p>
Compute by using that one weird trick:
</p>

<p>
\[ \gamma_t(j) = \frac{P(q_t=j,O|\lambda)}{P(O|\lambda)} = \frac{\alpha_t(j)\beta_t(j)|\lambda)}{P(O|\lambda)} \]
</p>

<p>
Now we can write:
</p>

<p>
\[ \hat{b}_j(v_k) = \frac{\sum_{t=1\text{s.t.}o_t=v_k}^T\gamma_t(j)}{\sum_{t=1}^T\gamma_t(j)} \]
</p>

<p>
Iteration consists of E step and M step. In the E-step, \(\gamma_t\) and \(\xi_t\) are computed, and then new estimates for \(\hat{a}_{ij}\) and \(\hat{b}_j(v_k)\) are computed.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-2">
<h2 id="sec-">Exercises</h2>
<div class="outline-text-2" id="text-">
<p>
Exercises 9.1 and 9.2:
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">ns</span> <span class="org-type">exercises-9</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">hmm</span>
  <span class="org-rainbow-delimiters-depth-2">[]</span>
  <span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">"START"</span> <span class="org-rainbow-delimiters-depth-3">{</span><span class="org-clojure-keyword">:op</span> <span class="org-rainbow-delimiters-depth-4">{}</span>
            <span class="org-clojure-keyword">:edges</span> <span class="org-rainbow-delimiters-depth-4">{}</span><span class="org-rainbow-delimiters-depth-3">}</span>
   <span class="org-string">"END"</span> <span class="org-rainbow-delimiters-depth-3">{</span><span class="org-clojure-keyword">:op</span> <span class="org-rainbow-delimiters-depth-4">{}</span>
          <span class="org-clojure-keyword">:edges</span> <span class="org-rainbow-delimiters-depth-4">{}</span><span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">add-node</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm node<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">op = observation probability</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>conj hmm <span class="org-rainbow-delimiters-depth-3">{</span>node <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:op</span> <span class="org-rainbow-delimiters-depth-5">{}</span>
                   <span class="org-clojure-keyword">:edges</span> <span class="org-rainbow-delimiters-depth-5">{}</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">add-obs-prob</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm node obs cost<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>assoc-in hmm <span class="org-rainbow-delimiters-depth-3">[</span>node <span class="org-clojure-keyword">:op</span> obs<span class="org-rainbow-delimiters-depth-3">]</span> cost<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">add-edge</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm start end weight<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>assoc-in hmm <span class="org-rainbow-delimiters-depth-3">[</span>start <span class="org-clojure-keyword">:edges</span> end<span class="org-rainbow-delimiters-depth-3">]</span> weight<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">nodes</span>
  <span class="org-doc">"Names of all nodes in the HMM"</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>keys hmm<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">obs-prob</span>
  <span class="org-doc">"P(o|q). If not defined, nil."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm node obs<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>get-in hmm <span class="org-rainbow-delimiters-depth-3">[</span>node <span class="org-clojure-keyword">:op</span> obs<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">transition-prob</span>
  <span class="org-doc">"Probability of transitioning from start to end. If not defined, 0."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm start end<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>get-in hmm <span class="org-rainbow-delimiters-depth-3">[</span>start <span class="org-clojure-keyword">:edges</span> end<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">parent-nodes</span>
  <span class="org-doc">"Returns dict where keys are nodes and values are the probability of</span>
<span class="org-doc">   transitioning from that node to a given node. Note that this algorithm</span>
<span class="org-doc">   is inefficient. If this were real, we'd find a space trade-off to make</span>
<span class="org-doc">   this operation O(1)."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm given-node<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>reduce <span class="org-rainbow-delimiters-depth-3">(</span>fn <span class="org-rainbow-delimiters-depth-4">[</span>d <span class="org-rainbow-delimiters-depth-5">[</span>node <span class="org-rainbow-delimiters-depth-6">{</span><span class="org-clojure-keyword">:keys</span> <span class="org-rainbow-delimiters-depth-7">[</span>edges<span class="org-rainbow-delimiters-depth-7">]</span><span class="org-rainbow-delimiters-depth-6">}</span><span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">]</span>
            <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">if-let</span> <span class="org-rainbow-delimiters-depth-5">[</span>p <span class="org-rainbow-delimiters-depth-6">(</span>get edges given-node<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">]</span>
              <span class="org-rainbow-delimiters-depth-5">(</span>assoc d node p<span class="org-rainbow-delimiters-depth-5">)</span>
              d<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
          <span class="org-rainbow-delimiters-depth-3">{}</span>
          hmm<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">prob-of-transition-from</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm node start<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>get <span class="org-rainbow-delimiters-depth-3">(</span>parent-nodes hmm node<span class="org-rainbow-delimiters-depth-3">)</span> start <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>


<span class="org-comment-delimiter">;; </span><span class="org-comment">algorithms ------------------------------------------------------------</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">forward</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">fwd-init-alphas</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>reduce <span class="org-rainbow-delimiters-depth-3">(</span>fn <span class="org-rainbow-delimiters-depth-4">[</span>alphas node<span class="org-rainbow-delimiters-depth-4">]</span>
            <span class="org-rainbow-delimiters-depth-4">(</span>assoc alphas
                   node
                   <span class="org-rainbow-delimiters-depth-5">(</span>* <span class="org-rainbow-delimiters-depth-6">(</span>prob-of-transition-from hmm node <span class="org-string">"START"</span><span class="org-rainbow-delimiters-depth-6">)</span>
                      <span class="org-rainbow-delimiters-depth-6">(</span>obs-prob hmm node obs<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
          <span class="org-rainbow-delimiters-depth-3">{}</span>
          <span class="org-rainbow-delimiters-depth-3">(</span>nodes hmm<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">fwd-update-alpha</span>
  <span class="org-doc">"For a given node and a given observation, generate a new alpha"</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm alphas obs new-alphas cur-node<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">-&gt;&gt;</span> <span class="org-rainbow-delimiters-depth-3">(</span>parent-nodes hmm cur-node<span class="org-rainbow-delimiters-depth-3">)</span>
       <span class="org-rainbow-delimiters-depth-3">(</span>map <span class="org-rainbow-delimiters-depth-4">(</span>fn <span class="org-rainbow-delimiters-depth-5">[</span><span class="org-rainbow-delimiters-depth-6">[</span>pnode transition-prob<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">]</span>
              <span class="org-rainbow-delimiters-depth-5">(</span>* <span class="org-rainbow-delimiters-depth-6">(</span>get alphas pnode <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-6">)</span>
                 transition-prob
                 <span class="org-rainbow-delimiters-depth-6">(</span>obs-prob hmm cur-node obs<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
       <span class="org-rainbow-delimiters-depth-3">(</span>reduce +<span class="org-rainbow-delimiters-depth-3">)</span>
       <span class="org-rainbow-delimiters-depth-3">(</span>assoc new-alphas cur-node<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">fwd-inner</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs-seq<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">tail-recursive loop: iterate over each obs, updating the alphas</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">loop</span> <span class="org-rainbow-delimiters-depth-3">[</span>alphas <span class="org-rainbow-delimiters-depth-4">(</span>fwd-init-alphas hmm <span class="org-rainbow-delimiters-depth-5">(</span>first obs-seq<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">[</span>obs &amp; remaining-obs<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-4">(</span>rest obs-seq<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>nil? obs<span class="org-rainbow-delimiters-depth-4">)</span>
      alphas
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">recur</span>
       <span class="org-rainbow-delimiters-depth-5">(</span>reduce <span class="org-rainbow-delimiters-depth-6">(</span>partial fwd-update-alpha hmm alphas obs<span class="org-rainbow-delimiters-depth-6">)</span>
               <span class="org-rainbow-delimiters-depth-6">{}</span>
               <span class="org-rainbow-delimiters-depth-6">(</span>nodes hmm<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
       remaining-obs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">fwd-terminate</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm alphas<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>reduce <span class="org-rainbow-delimiters-depth-3">(</span>fn <span class="org-rainbow-delimiters-depth-4">[</span>sum <span class="org-rainbow-delimiters-depth-5">[</span>node alpha<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">]</span>
            <span class="org-rainbow-delimiters-depth-4">(</span>+ sum
               <span class="org-rainbow-delimiters-depth-5">(</span>* alpha
                  <span class="org-rainbow-delimiters-depth-6">(</span>transition-prob hmm node <span class="org-string">"END"</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
          <span class="org-highlight-numbers-number">0</span>
          alphas<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">fwd</span>
  <span class="org-doc">"Takes an HMM and a sequence of observations and calculates the</span>
<span class="org-doc">   probability assigned to the obs seq."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs-seq<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">[</span>alphas <span class="org-rainbow-delimiters-depth-4">(</span>fwd-inner hmm obs-seq<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>fwd-terminate hmm alphas<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">viterbi</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">instead of alphas we use pairs--this is just a 2-vector of the previous</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">node name with the current node's alpha</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">vtb-init-pairs</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>reduce <span class="org-rainbow-delimiters-depth-3">(</span>fn <span class="org-rainbow-delimiters-depth-4">[</span>pairs node<span class="org-rainbow-delimiters-depth-4">]</span>
            <span class="org-rainbow-delimiters-depth-4">(</span>assoc pairs
                   node
                   <span class="org-rainbow-delimiters-depth-5">[</span><span class="org-string">"START"</span>
                    <span class="org-rainbow-delimiters-depth-6">(</span>* <span class="org-rainbow-delimiters-depth-7">(</span>prob-of-transition-from hmm node <span class="org-string">"START"</span><span class="org-rainbow-delimiters-depth-7">)</span>
                       <span class="org-rainbow-delimiters-depth-7">(</span>obs-prob hmm node obs<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
          <span class="org-rainbow-delimiters-depth-3">{}</span>
          <span class="org-rainbow-delimiters-depth-3">(</span>nodes hmm<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">vtb-update-pair</span>
  <span class="org-doc">"For a given node and a given observation, generate a new pair"</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm pairs obs new-pairs cur-node<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">if-let</span> <span class="org-rainbow-delimiters-depth-3">[</span>new-pair <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">-&gt;&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span>parent-nodes hmm cur-node<span class="org-rainbow-delimiters-depth-5">)</span>
                         <span class="org-rainbow-delimiters-depth-5">(</span>map <span class="org-rainbow-delimiters-depth-6">(</span>fn <span class="org-rainbow-delimiters-depth-7">[</span><span class="org-rainbow-delimiters-depth-8">[</span>pnode transition-prob<span class="org-rainbow-delimiters-depth-8">]</span><span class="org-rainbow-delimiters-depth-7">]</span>
                                <span class="org-rainbow-delimiters-depth-7">[</span>pnode
                                 <span class="org-rainbow-delimiters-depth-8">(</span>* <span class="org-rainbow-delimiters-depth-9">(</span><span class="org-keyword">or</span> <span class="org-rainbow-delimiters-depth-1">(</span>some-&gt;&gt; <span class="org-rainbow-delimiters-depth-2">(</span>get pairs pnode<span class="org-rainbow-delimiters-depth-2">)</span>
                                                 second<span class="org-rainbow-delimiters-depth-1">)</span>
                                        <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-9">)</span>
                                    transition-prob
                                    <span class="org-rainbow-delimiters-depth-9">(</span>obs-prob hmm cur-node obs<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">]</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                         <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">(</span>fn <span class="org-rainbow-delimiters-depth-7">[</span>pairs<span class="org-rainbow-delimiters-depth-7">]</span>
                            <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-8">(</span>empty? pairs<span class="org-rainbow-delimiters-depth-8">)</span>
                              <span class="org-constant">nil</span>
                              <span class="org-rainbow-delimiters-depth-8">(</span>reduce <span class="org-rainbow-delimiters-depth-9">(</span>fn <span class="org-rainbow-delimiters-depth-1">[</span>max n<span class="org-rainbow-delimiters-depth-1">]</span>
                                        <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>&gt; <span class="org-rainbow-delimiters-depth-3">(</span>second n<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span>second max<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
                                          n
                                          max<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-9">)</span>
                                      pairs<span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>assoc new-pairs cur-node new-pair<span class="org-rainbow-delimiters-depth-3">)</span>
    new-pairs<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">vtb-inner</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs-seq<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">tail-recursive loop: iterate over each obs, updating the pairs</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">loop</span> <span class="org-rainbow-delimiters-depth-3">[</span>backtrace '<span class="org-rainbow-delimiters-depth-4">()</span>
         pairs <span class="org-rainbow-delimiters-depth-4">(</span>vtb-init-pairs hmm <span class="org-rainbow-delimiters-depth-5">(</span>first obs-seq<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">[</span>obs &amp; remaining-obs<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-4">(</span>rest obs-seq<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>nil? obs<span class="org-rainbow-delimiters-depth-4">)</span>
      <span class="org-rainbow-delimiters-depth-4">[</span>pairs backtrace<span class="org-rainbow-delimiters-depth-4">]</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-5">[</span>pairs <span class="org-rainbow-delimiters-depth-6">(</span>reduce <span class="org-rainbow-delimiters-depth-7">(</span>partial vtb-update-pair hmm pairs obs<span class="org-rainbow-delimiters-depth-7">)</span>
                          <span class="org-rainbow-delimiters-depth-7">{}</span>
                          <span class="org-rainbow-delimiters-depth-7">(</span>nodes hmm<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span>
            backtrace <span class="org-rainbow-delimiters-depth-6">(</span>cons <span class="org-rainbow-delimiters-depth-7">(</span>reduce <span class="org-rainbow-delimiters-depth-8">(</span>fn <span class="org-rainbow-delimiters-depth-9">[</span>bt <span class="org-rainbow-delimiters-depth-1">[</span>node <span class="org-rainbow-delimiters-depth-2">[</span>source-node _<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span><span class="org-rainbow-delimiters-depth-9">]</span>
                                      <span class="org-rainbow-delimiters-depth-9">(</span>assoc bt node source-node<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span>
                                    <span class="org-rainbow-delimiters-depth-8">{}</span>
                                    pairs<span class="org-rainbow-delimiters-depth-7">)</span>
                            backtrace<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">]</span>
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">recur</span> backtrace pairs remaining-obs<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn-</span> <span class="org-function-name">vtb-terminate</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm pairs backtrace<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-rainbow-delimiters-depth-4">[</span>winning-node &amp; _<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-4">(</span>reduce <span class="org-rainbow-delimiters-depth-5">(</span>fn <span class="org-rainbow-delimiters-depth-6">[</span><span class="org-rainbow-delimiters-depth-7">[</span>winner winner-prev winner-cost<span class="org-rainbow-delimiters-depth-7">]</span> <span class="org-rainbow-delimiters-depth-7">[</span>node <span class="org-rainbow-delimiters-depth-8">[</span>pnode alpha<span class="org-rainbow-delimiters-depth-8">]</span><span class="org-rainbow-delimiters-depth-7">]</span><span class="org-rainbow-delimiters-depth-6">]</span>
                                     <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-7">[</span>cost <span class="org-rainbow-delimiters-depth-8">(</span>* alpha <span class="org-rainbow-delimiters-depth-9">(</span>transition-prob hmm node <span class="org-string">"END"</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">]</span>
                                       <span class="org-rainbow-delimiters-depth-7">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-8">(</span>&gt; cost winner-cost<span class="org-rainbow-delimiters-depth-8">)</span>
                                         <span class="org-rainbow-delimiters-depth-8">[</span>node pnode cost<span class="org-rainbow-delimiters-depth-8">]</span>
                                         <span class="org-rainbow-delimiters-depth-8">[</span>winner winner-prev winner-cost<span class="org-rainbow-delimiters-depth-8">]</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                                   <span class="org-rainbow-delimiters-depth-5">[</span><span class="org-string">"ERR"</span> <span class="org-string">"ERR"</span> <span class="org-highlight-numbers-number">0</span><span class="org-rainbow-delimiters-depth-5">]</span>
                                   pairs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">loop</span> <span class="org-rainbow-delimiters-depth-4">[</span>node winning-node
           backtrace backtrace
           path '<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">]</span>
      <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-5">(</span>nil? node<span class="org-rainbow-delimiters-depth-5">)</span>
        path
        <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">recur</span>
         <span class="org-rainbow-delimiters-depth-6">(</span>get <span class="org-rainbow-delimiters-depth-7">(</span>first backtrace<span class="org-rainbow-delimiters-depth-7">)</span> node<span class="org-rainbow-delimiters-depth-6">)</span>
         <span class="org-rainbow-delimiters-depth-6">(</span>rest backtrace<span class="org-rainbow-delimiters-depth-6">)</span>
         <span class="org-rainbow-delimiters-depth-6">(</span>cons node path<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">vtb</span>
  <span class="org-doc">"Takes an HMM and a sequence of observations and calculates the</span>
<span class="org-doc">   probability assigned to the obs seq."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>hmm obs-seq<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-rainbow-delimiters-depth-4">[</span>pairs backtrace<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-4">(</span>vtb-inner hmm obs-seq<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>vtb-terminate hmm pairs backtrace<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>


<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">-main</span>
  <span class="org-rainbow-delimiters-depth-2">[]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">[</span>hmm1 <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">-&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span>hmm<span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-node <span class="org-string">"hot"</span><span class="org-rainbow-delimiters-depth-5">)</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">"START" and "END" already added</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-node <span class="org-string">"cold"</span><span class="org-rainbow-delimiters-depth-5">)</span>

                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"START"</span> <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">0.8</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"START"</span> <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">0.2</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"hot"</span> <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">0.6</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"hot"</span> <span class="org-string">"END"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"hot"</span> <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">0.3</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"cold"</span> <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">0.5</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"cold"</span> <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">0.4</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"cold"</span> <span class="org-string">"END"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span>

                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">0.2</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">0.4</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"hot"</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">0.4</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">0.5</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">0.4</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
        hmm2 <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">-&gt;</span> <span class="org-rainbow-delimiters-depth-5">(</span>hmm<span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-node <span class="org-string">"healthy"</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-node <span class="org-string">"fever"</span><span class="org-rainbow-delimiters-depth-5">)</span>

                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"START"</span> <span class="org-string">"healthy"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.6</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"START"</span> <span class="org-string">"fever"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.4</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"healthy"</span> <span class="org-string">"healthy"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.7</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"healthy"</span> <span class="org-string">"fever"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.3</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"fever"</span> <span class="org-string">"fever"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.6</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"fever"</span> <span class="org-string">"healthy"</span> <span class="org-rainbow-delimiters-depth-6">(</span>/ <span class="org-highlight-numbers-number">0.4</span> <span class="org-highlight-numbers-number">0.9</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>

                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"fever"</span> <span class="org-string">"END"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-edge <span class="org-string">"healthy"</span> <span class="org-string">"END"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span>

                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"healthy"</span> <span class="org-string">"dizzy"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"healthy"</span> <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">0.4</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"healthy"</span> <span class="org-string">"normal"</span> <span class="org-highlight-numbers-number">0.5</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"fever"</span> <span class="org-string">"dizzy"</span> <span class="org-highlight-numbers-number">0.6</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"fever"</span> <span class="org-string">"cold"</span> <span class="org-highlight-numbers-number">0.3</span><span class="org-rainbow-delimiters-depth-5">)</span>
                 <span class="org-rainbow-delimiters-depth-5">(</span>add-obs-prob <span class="org-string">"fever"</span> <span class="org-string">"normal"</span> <span class="org-highlight-numbers-number">0.1</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>fwd hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; 0.002193...</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>fwd hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; 1.5832...e-6</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>fwd hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; 1.7264...e-6</span>

    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>vtb hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (hot hot hot)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>vtb hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (hot hot cold cold hot hot hot hot hot)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>vtb hmm1 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">3</span> <span class="org-highlight-numbers-number">1</span> <span class="org-highlight-numbers-number">2</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (hot hot cold cold hot hot hot cold cold)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>println <span class="org-rainbow-delimiters-depth-4">(</span>vtb hmm2 '<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"normal"</span> <span class="org-string">"cold"</span> <span class="org-string">"dizzy"</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (healthy healthy fever)</span>

<span class="org-rainbow-delimiters-depth-1">(</span>-main<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-">Notes</a>
<ul class="nav">
<li><a href="#sec-">9.1 Markov Chains</a></li>
<li><a href="#sec-">9.2 Hidden Markov Models</a></li>
<li><a href="#sec-">9.3 Computing likelihood, forward algorithm</a></li>
<li><a href="#sec-">9.4 Decoding, Viterbi algorithm</a></li>
<li><a href="#sec-">9.5 Training, forward-backward algorithm</a></li>
</ul>
</li>
<li><a href="#sec-">Exercises</a></li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div class="container"><div class="row"><div class="col-md-9"><div id="disqus_thread"></div></div></div></div>
</footer>
</body>
</html>
